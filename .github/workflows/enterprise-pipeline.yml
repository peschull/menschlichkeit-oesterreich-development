name: ğŸ”„ CI/CD Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip Tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PHP_VERSION: '8.4'
  PYTHON_VERSION: '3.11'

jobs:
  # ===============================
  # WORKSPACE SETUP & VALIDATION
  # ===============================
  setup:
    name: ğŸ”§ Workspace Setup
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect-changes.outputs.matrix }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Changes
        id: detect-changes
        run: |
          matrix='{"include":['
          if git diff --name-only HEAD~1 | \
             grep -E "^frontend/|^figma-design-system/" || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            matrix+='{"service":"frontend","path":"frontend/",
            "port":"3000"},'
          fi
          if git diff --name-only HEAD~1 | \
             grep -E "^api\.|^requirements\.txt" || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            matrix+='{"service":"api",
            "path":"api.menschlichkeit-oesterreich.at/","port":"8001"},'
          fi
          if git diff --name-only HEAD~1 | \
             grep -E "^crm\.|^composer\.json" || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            matrix+='{"service":"crm",
            "path":"crm.menschlichkeit-oesterreich.at/","port":"8000"},'
          fi
          if git diff --name-only HEAD~1 | \
             grep -E "^web/games|^web/themes" || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            matrix+='{"service":"games","path":"web/","port":"3001"},'
          fi
          if git diff --name-only HEAD~1 | \
             grep -E "^website/" || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            matrix+='{"service":"website","path":"website/",
            "port":"8080"},'
          fi
          if git diff --name-only HEAD~1 | \
             grep -E "^automation/n8n/" || \
             [ "${{ github.event_name }}" = "schedule" ]; then
            matrix+='{"service":"n8n","path":"automation/n8n/",
            "port":"5678"},'
          fi
          # Remove trailing comma if present
          matrix="${matrix%,}"
          matrix+=']}'
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  # ===============================
  # QUALITY GATES - STAGE 1
  # ===============================
  quality-gates:
    name: ğŸ›¡ï¸ Quality Gates
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.matrix != '{"include":[]}'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ’… Prettier Check
        run: npm run format:check

      - name: ğŸ” ESLint Analysis
        run: npm run lint

      - name: ğŸ§© DSGVO Compliance Check
        run: npm run compliance:dsgvo

      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json

      - name: ğŸ“¦ Install PHP Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: ğŸ” PHPStan Analysis
        run: vendor/bin/phpstan analyse --no-progress

      - name: ğŸ”’ Security Check - Trivy
        uses: aquasecurity/trivy-action@0.19.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Security Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ===============================
  # TESTING STAGE
  # ===============================
  testing:
    name: ğŸ§ª Testing Suite
    runs-on: ubuntu-latest
    needs: [setup, quality-gates]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      fail-fast: false

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        ports:
          - 5432:5432

      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.path }}package.json

      - name: ğŸ“¦ Install Dependencies - ${{ matrix.service }}
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: ğŸ§ª Unit Tests - ${{ matrix.service }}
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            npm test -- --coverage
          fi

      - name: ğŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          directory: ${{ matrix.path }}
          flags: ${{ matrix.service }}

  # ===============================
  # SECURITY SCANNING
  # ===============================
  security-scan:
    name: ğŸ” Security Analysis
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”’ Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ğŸ” CodeQL Analysis
        uses: github/codeql-action/init@v4
        with:
          languages: javascript, python, php

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: ğŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      - name: ğŸ•µï¸ Secret Scanning
        run: |
          echo "Checking for accidentally committed secrets..."
          if grep -r "password.*=" . --exclude-dir=node_modules --exclude-dir=.git || \
             grep -r "api[_-]key.*=" . --exclude-dir=node_modules --exclude-dir=.git || \
             grep -r "secret.*=" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Potential secrets found!"
            exit 1
          else
            echo "âœ… No secrets detected"
          fi

  # ===============================
  # CODACY ANALYSIS
  # ===============================
  codacy-analysis:
    name: ğŸ“Š Codacy Quality Analysis
    runs-on: ubuntu-latest
    needs: quality-gates

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Codacy Analysis CLI
        uses: codacy/codacy-analysis-cli-action@master
        with:
          api-token: ${{ secrets.CODACY_API_TOKEN }}
          upload: true
          max-allowed-issues: 50

  # ===============================
  # PERFORMANCE TESTING
  # ===============================
  performance:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: [setup, testing]
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Application - ${{ matrix.service }}
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package.json ] && grep -q '"build"' package.json; then
            npm run build
          fi

      - name: ğŸš€ Start Test Server
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package.json ] && grep -q '"start"' package.json; then
            npm start &
            sleep 30
          fi

      - name: ğŸ”¬ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouse.config.cjs'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ===============================
  # ACCESSIBILITY TESTING
  # ===============================
  accessibility:
    name: â™¿ Accessibility (pa11y-ci)
    runs-on: ubuntu-latest
    needs: [setup, testing]
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: frontend
        run: npm ci

      - name: ğŸš€ Start Frontend Dev Server
        working-directory: frontend
        run: |
          npm run a11y:start &
          npx wait-on http://localhost:5173

      - name: â™¿ Run pa11y-ci
        working-directory: frontend
        run: npx pa11y-ci --config ../pa11yci.json

  # ===============================
  # E2E TESTING
  # ===============================
  e2e-testing:
    name: ğŸ­ E2E Testing (Playwright)
    runs-on: ubuntu-latest
    needs: [setup, testing]
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps

      - name: ğŸš€ Start All Services
        run: |
          npm run dev:all &
          sleep 60

      - name: ğŸ§ª Run E2E Tests
        run: npx playwright test

      - name: ğŸ“Š Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: playwright-results/

  # ===============================
  # BUILD & PACKAGE
  # ===============================
  build:
    name: ğŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [quality-gates, security-scan]
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Dependencies - ${{ matrix.service }}
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: ğŸ—ï¸ Build - ${{ matrix.service }}
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package.json ] && grep -q '"build"' package.json; then
            npm run build
          fi

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service }}
          path: ${{ matrix.path }}dist/
          retention-days: 7

  # ===============================
  # STAGING DEPLOYMENT
  # ===============================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, performance, e2e-testing]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./builds

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to Staging Server
        run: |
          echo "Deploying to staging..."
          ./deployment-scripts/deploy-api-plesk.sh staging
          ./deployment-scripts/deploy-crm-plesk.sh staging

      - name: ğŸ” Health Check - Staging
        run: |
          ./scripts/test-deployment.sh staging

  # ===============================
  # PRODUCTION DEPLOYMENT
  # ===============================
  deploy-production:
    name: ğŸ† Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, performance, e2e-testing]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./builds

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy to Production Server
        run: |
          echo "Deploying to production..."
          ./deployment-scripts/deploy-api-plesk.sh production
          ./deployment-scripts/deploy-crm-plesk.sh production

      - name: ğŸ” Health Check - Production
        run: |
          ./scripts/test-deployment.sh production

      - name: ğŸ“Š Post-Deployment Monitoring
        run: |
          echo "Starting post-deployment monitoring..."
          ./scripts/production-readiness-validator.py

  # ===============================
  # NOTIFICATIONS & REPORTING
  # ===============================
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: ğŸ“§ Notify Success
        if: needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success'
        run: |
          echo "âœ… Deployment successful!"
          curl -X POST "${{ secrets.N8N_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "success",
              "environment": "${{ github.event.inputs.environment || 'auto' }}",
              "commit": "${{ github.sha }}",
              "actor": "${{ github.actor }}"
            }'

      - name: ğŸš¨ Notify Failure
        if: needs.deploy-production.result == 'failure' || needs.deploy-staging.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          curl -X POST "${{ secrets.N8N_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "failed",
              "environment": "${{ github.event.inputs.environment || 'auto' }}",
              "commit": "${{ github.sha }}",
              "actor": "${{ github.actor }}"
            }'
