name: Quality

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  quality:
    name: Lint & Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # ref: v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # ref: v4
        with:
          node-version: "20"
          cache: npm

      - name: Detect JS/TS changes
        id: changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # ref: v3
        with:
          list-files: json
          filters: |
            js:
              - '**/*.js'
              - '**/*.mjs'
              - '**/*.cjs'
              - '**/*.ts'
              - '**/*.tsx'
              - 'package.json'
              - 'package-lock.json'
              - 'pnpm-lock.yaml'
              - 'yarn.lock'
              - 'eslint.config.*'
              - '.eslintrc*'
              - 'tsconfig.json'

      - name: Skip if nothing relevant changed (unless dispatch)
        if: github.event_name != 'workflow_dispatch' && steps.changes.outputs.js == '[]'
        run: echo "No relevant changes — skipping."

      - name: Install dependencies
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.js != '[]'
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f pnpm-lock.yaml ]]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [[ -f yarn.lock ]]; then
            corepack enable
            yarn install --frozen-lockfile
          elif [[ -f package-lock.json ]]; then
            npm ci --no-audit --no-fund
          elif [[ -f package.json ]]; then
            npm i --no-audit --no-fund
          else
            echo "No package.json — skipping install."
          fi

      - name: ESLint
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.js != '[]'
        shell: bash
        run: |
          if npx --yes eslint -v >/dev/null 2>&1; then
            # Fail on errors, but allow warnings to avoid blocking PRs for non-critical issues
            npx eslint . || {
              status=$?
              if [ "$status" -ne 1 ]; then exit "$status"; fi
              echo "ESLint reported issues; proceeding (warnings allowed)."
            }
          else
            echo "ESLint not configured — skipping."
          fi

      - name: ESLint SARIF
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.js != '[]'
        shell: bash
        run: |
          if npx --yes eslint -v >/dev/null 2>&1; then
            npx eslint . --format @microsoft/eslint-formatter-sarif --output-file eslint.sarif || true
          else
            echo "ESLint not configured — skipping SARIF."
          fi

      - name: Upload SARIF (non-fork PRs only)
        if: |
          (github.event_name == 'workflow_dispatch' || steps.changes.outputs.js != '[]') &&
          (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) &&
          hashFiles('eslint.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: eslint.sarif
          category: eslint
