name: OSV Scanner

on:
  push:
    branches: [main, master, chore/**, feature/**]
  pull_request:
    branches: [main, master]
  schedule:
    # Daily scan at 5:00 UTC
    - cron: '0 5 * * *'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  osv-scanner:
    name: OSV Vulnerability Scanner
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OSV Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            --format=sarif
            --output=osv-results.sarif
            --recursive
            ./
        continue-on-error: true

      - name: Upload OSV Scanner results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: osv-results.sarif
          category: osv-scanner

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: osv-scanner-results
          path: osv-results.sarif
          retention-days: 30

  osv-lockfile:
    name: OSV Lockfile Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan package-lock.json
        uses: google/osv-scanner-action@
        if: hashFiles('**/package-lock.json') != ''
        with:
          scan-args: |-
            --lockfile=package-lock.json:npm
        continue-on-error: true

      - name: Scan composer.lock
        uses: google/osv-scanner-action@v1
        if: hashFiles('**/composer.lock') != ''
        with:
          scan-args: |-
            --lockfile=composer.lock:composer
        continue-on-error: true

      - name: Scan requirements.txt
        uses: google/osv-scanner-action
        if: hashFiles('**/requirements.txt') != ''
        with:
          scan-args: |-
            --lockfile=api.menschlichkeit-oesterreich.at/requirements.txt:requirements.txt
        continue-on-error: true
