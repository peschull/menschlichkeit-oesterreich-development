name: ğŸš€ Codespace Health Check
on:
  push:
    branches: [ main, develop ]
    paths:
      - '.devcontainer/**'
      - 'package.json'
      - '.env.example'
  pull_request:
    branches: [ main ]
    paths:
      - '.devcontainer/**'
  workflow_dispatch:

jobs:
  codespace-test:
    name: ğŸ“± Test Codespace Configuration
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸ“Š Validate devcontainer.json
        run: |
          echo "ğŸ” Validating devcontainer.json..."
          if [ -f .devcontainer/devcontainer.json ]; then
            echo "âœ… devcontainer.json exists"
            # JSON Syntax validation
            jq empty .devcontainer/devcontainer.json && echo "âœ… Valid JSON" || exit 1
          else
            echo "âŒ devcontainer.json missing"
            exit 1
          fi

      - name: ğŸ” Check Required Scripts
        run: |
          echo "ğŸ” Checking Codespace scripts..."

          scripts=(".devcontainer/codespace-optimized-setup.sh" ".devcontainer/codespace-post-create.sh")

          for script in "${scripts[@]}"; do
            if [ -f "$script" ]; then
              echo "âœ… $script exists"
              # Check if script is valid bash
              bash -n "$script" && echo "âœ… $script syntax OK" || exit 1
            else
              echo "âŒ $script missing"
              exit 1
            fi
          done

      - name: ğŸ“¦ Test Dependencies Installation
        run: |
          echo "ğŸ“¦ Testing dependency installation..."

          # NPM Dependencies
          npm install
          echo "âœ… NPM install successful"

          # Composer Dependencies (ignore platform for CI)
          composer install --ignore-platform-reqs --no-interaction
          echo "âœ… Composer install successful"

          # Python Dependencies
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "âœ… Python dependencies installed"
          fi

      - name: ğŸ—„ï¸ Test Database Setup
        run: |
          echo "ğŸ—„ï¸ Testing database setup simulation..."

          # Simulate MariaDB setup (without actual DB)
          echo "CREATE DATABASE IF NOT EXISTS mo_laravel_api_dev;" > test_db_setup.sql
          echo "CREATE DATABASE IF NOT EXISTS mo_civicrm_dev;" >> test_db_setup.sql
          echo "CREATE USER IF NOT EXISTS 'laravel_dev'@'localhost';" >> test_db_setup.sql

          echo "âœ… Database setup script generated"
          cat test_db_setup.sql

      - name: ğŸŒ Test Port Configuration
        run: |
          echo "ğŸŒ Testing port configuration..."

          # Check if ports are defined in devcontainer.json
          PORTS=$(jq -r '.forwardPorts[]?' .devcontainer/devcontainer.json 2>/dev/null || echo "")

          if [ ! -z "$PORTS" ]; then
            echo "âœ… Ports configured: $PORTS"
          else
            echo "âŒ No ports configured"
            exit 1
          fi

          # Validate port attributes
          jq -r '.portsAttributes | keys[]' .devcontainer/devcontainer.json | while read port; do
            echo "âœ… Port $port configured with attributes"
          done

      - name: ğŸ” Test SSH Key Handling
        run: |
          echo "ğŸ” Testing SSH key setup simulation..."

          # Simulate SSH key setup (without real key)
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Test SSH config
          echo "Host plesk-server" > ~/.ssh/config
          echo "  HostName 5.183.217.146" >> ~/.ssh/config
          echo "  User dmpl20230054" >> ~/.ssh/config
          echo "  Port 22" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> ~/.ssh/config

          echo "âœ… SSH configuration test complete"

      - name: âš™ï¸ Test Environment Configuration
        run: |
          echo "âš™ï¸ Testing environment configuration..."

          # Test .env.example validity
          if [ -f .env.example ]; then
            echo "âœ… .env.example exists"

            # Check for required variables
            required_vars=("NODE_ENV" "DEBUG" "LARAVEL_DB_HOST" "CIVICRM_DB_HOST")

            for var in "${required_vars[@]}"; do
              if grep -q "^$var=" .env.example || grep -q "^#.*$var=" .env.example; then
                echo "âœ… $var found in .env.example"
              else
                echo "âŒ $var missing in .env.example"
              fi
            done
          else
            echo "âŒ .env.example missing"
            exit 1
          fi

      - name: ğŸš€ Test Service Start Commands
        run: |
          echo "ğŸš€ Testing service start commands..."

          # Check if package.json has required scripts
          scripts=("dev:all" "codespace:setup" "codespace:fix" "codespace:post-start")

          for script in "${scripts[@]}"; do
            if jq -e ".scripts.\"$script\"" package.json > /dev/null; then
              echo "âœ… Script '$script' defined in package.json"
            else
              echo "âŒ Script '$script' missing in package.json"
              exit 1
            fi
          done

      - name: ğŸ“‹ Generate Codespace Health Report
        if: always()
        run: |
          echo "# ğŸ“‹ Codespace Health Report" > codespace-health-report.md
          echo "**Generated:** $(date)" >> codespace-health-report.md
          echo "" >> codespace-health-report.md

          echo "## âœ… Configuration Status" >> codespace-health-report.md
          echo "- devcontainer.json: Valid" >> codespace-health-report.md
          echo "- Setup scripts: Present" >> codespace-health-report.md
          echo "- Dependencies: Installable" >> codespace-health-report.md
          echo "- Port forwarding: Configured" >> codespace-health-report.md
          echo "- Environment: Templates ready" >> codespace-health-report.md
          echo "" >> codespace-health-report.md

          echo "## ğŸŒ Service Ports" >> codespace-health-report.md
          echo "- Frontend (React): 3000" >> codespace-health-report.md
          echo "- API (FastAPI): 8001" >> codespace-health-report.md
          echo "- CRM (CiviCRM): 8000" >> codespace-health-report.md
          echo "- Games Platform: 3001" >> codespace-health-report.md
          echo "- n8n Automation: 5678" >> codespace-health-report.md
          echo "- Website: 8080" >> codespace-health-report.md
          echo "" >> codespace-health-report.md

          echo "## ğŸ”§ Quick Fix Commands" >> codespace-health-report.md
          echo '```bash' >> codespace-health-report.md
          echo "# Setup Codespace" >> codespace-health-report.md
          echo "npm run codespace:setup" >> codespace-health-report.md
          echo "" >> codespace-health-report.md
          echo "# Fix common issues" >> codespace-health-report.md
          echo "npm run codespace:fix" >> codespace-health-report.md
          echo "" >> codespace-health-report.md
          echo "# Start all services" >> codespace-health-report.md
          echo "npm run dev:all" >> codespace-health-report.md
          echo '```' >> codespace-health-report.md

      - name: ğŸ“¤ Upload Health Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: codespace-health-report
          path: codespace-health-report.md
          retention-days: 30

  notify-codespace-status:
    name: ğŸ“¢ Notify Codespace Status
    runs-on: ubuntu-latest
    needs: [codespace-test]
    if: always()

    steps:
      - name: âœ… Success Notification
        if: needs.codespace-test.result == 'success'
        run: |
          echo "âœ… Codespace configuration is healthy!"
          echo "ğŸš€ Ready for GitHub Codespaces development"

      - name: âŒ Failure Notification
        if: needs.codespace-test.result == 'failure'
        run: |
          echo "âŒ Codespace configuration has issues!"
          echo "ğŸ”§ Check the logs and fix configuration files"
          exit 1
