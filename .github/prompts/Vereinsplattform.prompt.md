# üèõÔ∏è Super-Masterprompt: Vollst√§ndige Vereinsplattform mit Buchhaltung, Automatisierung & Community (besser als Best Practice)

## üéØ Auftrag & Rolle

Du bist Lead Architect (Frontend, Backend, Data, Finance, Security, DevOps, QA) f√ºr den Verein **Menschlichkeit √ñsterreich**.
Ziel: Baue ein **durchg√§ngig integriertes System** f√ºr **Mitglieder, Spenden & Buchhaltung**, mit **Automatisierungen in n8n**, **Web-Dashboard**, **Admin-Bereich**, **Mitgliederbereich** und **Community-Modulen**.
Alles **DSGVO-konform, barrierefrei (WCAG 2.2 AA), performant, sicher, testbar** und **l√ºckenlos dokumentiert**.

---

## 0) Anti-Ziele (hart)

* Keine ‚Äûlatest‚Äú-Dependencies ohne Lockfile/Pinning.
* Keine Speicherung sensibler Zahlungsdaten au√üerhalb zertifizierter PSPs.
* Keine ungetrackten manuellen Schritte ohne dokumentierten SOP.
* Keine irreversiblen Automatisierungen ohne Rollback/Retry/Idempotenz.

---

## 1) System-Scope (End-to-End)

* **Domainen:** Mitgliedschaft, Beitr√§ge, Spenden, Rechnungen/Belege, Buchungen, Bankabgleich, Mahnwesen, Reporting/BI.
* **Kan√§le:** Web (√∂ffentliche Seiten), Mitgliederportal, Admin-Konsole, Forum/Community.
* **Automatisierung:** n8n f√ºr ETL/ELT, Zahlungs-Webhooks, Bank-CSV-Import, Notifications, Workflows (Aufnahme, Verl√§ngerung, Austritt, Spendenquittungen, Mahnungen).
* **Schnittstellen:** CiviCRM (oder eigenes CRM), PSPs (Stripe/PayPal/EPS/Sofort/SEPA), Mail (SMTP/API), Files (S3/Blob), GitHub (CI/CD).

---

## 2) Architektur (High-Level)

* **Frontend:** React/Tailwind (oder SSR/Nuxt/Next) ‚Äì Mobile-first, i18n, A11y, SEO.
* **Backend:** Node/NestJS (oder Django/Spring), REST+OpenAPI, optional GraphQL, RBAC, Audit-Trail.
* **Datenbank:** PostgreSQL (OLTP), Redis (Queues/Caching), optional ClickHouse/BigQuery (Analytics).
* **Automations:** n8n (Worker + Webhook), getrennte Queues, Dead-Letter-Queue.
* **Storage:** S3-kompatibel (Dokumente, PDFs, Exporte).
* **Observability:** Logs strukturiert, Metriken (Prometheus/OpenTelemetry), Dashboards (Grafana), Alerts.
* **Infra:** Docker Compose (dev), IaC (Terraform) f√ºr prod, CI/CD (GitHub Actions).

---

## 3) Datenmodell (Kern-Entit√§ten, minimal)

* **Contact(Person/Org)**: name, birthdate, email, phone, address*, gdpr_flags, consents[].
* **Membership**: contact_id, type (ordentlich/au√üerordentlich/ehren), status, start_date, end_date, fee_category (standard/erm√§√üigt/h√§rtefall).
* **Contribution**: id, contact_id, amount_gross, amount_net, fee, tax_rate, financial_type (Mitgliedsbeitrag/Spende/Event), payment_instrument, currency, status, trxn_id (PSP), booked_at.
* **ContributionRecur**: schedule (monthly/quarterly/yearly), psp_subscription_id/mandate_id, next_charge_at, status.
* **Invoice**: number, contribution_id, pdf_url, due_date, paid_at, dunning_level.
* **SEPA Mandate**: mandate_id, iban, bic, creditor_id, signature_date, status.
* **Campaign/Fund** (Spendenzwecke): code, title, cost_center.
* **Ledger/Journal** (Buchhaltung): journal_entries[] (double-entry: debit, credit, account, amount, ref_id).
* **Forum**: topics, posts, tags, roles (moderator/member).
* **AuditLog**: actor, action, entity, before/after, ts, ip.

> **Hinweis:** Alle Entit√§ten mit `created_at`, `updated_at`, `version` (optimistic locking). DSGVO-relevant markieren.

---

## 4) Zahlungsarten (konkret & vollst√§ndig)

* **Bank:** √úberweisung (IBAN), **EPS** (AT), **Sofort/Klarna**.
* **SEPA**: Lastschrift/Dauerauftrag (Mandat, Gl√§ubiger-ID), wiederkehrend.
* **Debitkarte:** Maestro / Visa Debit / Mastercard Debit.
* **Kreditkarte:** Visa/Mastercard/Amex via PSP (Stripe/Mollie/Adyen).
* **Wallets:** PayPal, Apple Pay, Google Pay.
* **Physisch:** POS (SumUp/Zettle), Bar (nur Ausnahmesituationen, Quittungspflicht).
* **Mapping:** Jede Zahlart = eigenes `payment_instrument_id` + Konto/Kostenstelle in der Buchhaltung.

---

## 5) Buchhaltung (maximal robust)

* **Kontenplan & Financial Types**: Mitgliedsbeitr√§ge, Spenden, Geb√ºhren, Skonti, Rundungsdifferenzen, zweckgebundene Mittel (Fonds).
* **Double-Entry-Posting** (Journal):

  * Bei Zahlung: **Bank/Kasse an Erl√∂se** (ggf. Geb√ºhrenkonto, Tax-Split).
  * Bei Geb√ºhren (Stripe/PayPal): **Geb√ºhrenkonto** buchen, Netto vs. Brutto klar trennen.
* **Rechnungswesen**: Rechnung/Belegnummernkreis, Zahlziel, Mahnstufen (M1/M2/M3), Storno/Gutschrift.
* **Steuer**: Standardfall Verein ohne USt ‚Äì **aber** Tax-Engine konfigurierbar (USt-Satz, innergemeinschaftlich, Reverse Charge).
* **Abgleich**: Bank-CSV Import, automatische Zuordnung via `trxn_id`, Betrag, Verwendungszweck, Fuzzy-Match.
* **Exporte**: CSV/XLSX, DATEV-√§hnliches CSV, Standard-Buchungsjournal, Spendenauswertung je Kampagne.
* **Reporting/BI**: Deckungsbeitr√§ge, Spenden pro Kampagne, Mitgliederwachstum, Ausfallquoten, Aging-Liste f√ºr offene Posten.

---

## 6) Web-Oberfl√§chen

### √ñffentlicher Bereich

* **Mitglied werden** (Beitritt), **Spenden** (einmalig/wiederkehrend), **Statuten**, **Beitragsordnung**, **Transparenz** (Mittelverwendung).
* **A11y/SEO** strikt; Performance-Budgets (mobil): LCP ‚â§ 2.5s, INP ‚â§ 200ms, CLS ‚â§ 0.1.

### Mitgliederbereich

* Profil/Adresse/Bank aktualisieren, Mitgliedsstatus, Zahlungen/Belege, Abos verwalten (Pause/K√ºndigen), DSGVO-Self-Service (Export/L√∂schung), Forum-Zugang.

### Admin-Bereich

* Dashboard (KPIs: aktive Mitglieder, MRR aus Beitr√§gen, Spenden heute/Monat, offene Posten, Mahnstufen),
* **Buchhaltung**: Journal, Belege, Abgleich, Exporte, Periodenabschluss,
* **CRM**: Mitgliederpflege, Aufnahmeantr√§ge, Rollen/RBAC,
* **Automation Monitor**: n8n-Runs, DLQs, Retrys, manuelle Replays.

---

## 7) n8n-Automatisierungen (Workflows ‚Äì Blaupause)

**Designprinzipien:** Idempotenz (dedup keys), Retries (exponentiell), DLQ, Alerting, Tracing-IDs.

1. **Mitgliedsaufnahme**

* Trigger: Form Submit (Webhook) ‚Üí Validate ‚Üí `contact.get/create` ‚Üí `membership.create` (pending) ‚Üí Zahlungsaufforderung (Mail) ‚Üí Ticket f√ºr Vorstand (Review) ‚Üí nach Freigabe: Status=active ‚Üí Willkommensmail + Portalzugang.

2. **Beitragslauf (wiederkehrend)**

* Trigger: CRON (monatlich) ‚Üí hole aktive `ContributionRecur` ‚Üí PSP-Charge (Stripe/SEPA) ‚Üí `contribution.create` (pending) ‚Üí Webhook-Listener (PSP) ‚Üí Status Completed/Failed ‚Üí Mail (Erfolg/Fehlschlag) ‚Üí Journalbuchung.

3. **Spenden-Webhook**

* Trigger: Stripe/PayPal/EPS ‚Üí Match `contact` ‚Üí `contribution.create` ‚Üí Belegmail (PDF) ‚Üí Journalbuchung ‚Üí BI-Event.

4. **Bank-CSV-Abgleich**

* Trigger: Upload/IMAP ‚Üí Parse ‚Üí Fuzzy-Match auf offene Posten ‚Üí Auto-Zuordnung ‚Üí ‚ÄûUnklare Posten‚Äú in Queue ‚Üí Benachrichtigung.

5. **Mahnwesen**

* Trigger: t√§glich ‚Üí F√§llige Rechnungen ‚Üí M1/M2/M3 generieren ‚Üí E-Mail mit PDF ‚Üí Eskalation an Admin.

6. **DSGVO-Self-Service**

* Trigger: Portal Anfrage ‚Üí Export (JSON/CSV, ZIP) ‚Üí S3 link ‚Üí E-Mail.
* L√∂schung: Soft-Delete + Anonymisierung + Protokoll (Freigabe zweistufig).

7. **Dokumente/Belege**

* Trigger: Contribution Completed ‚Üí PDF-Generator ‚Üí S3 ‚Üí `invoice.update(pdf_url)` ‚Üí Mail.

> **Monitoring:** Jeder Workflow sendet Logs/Metriken (Durchsatz, Fehlerquote, Latenz) + Alerts an Admin-Channel.

---

## 8) Sicherheit & Compliance

* **RBAC**: Rollen (Admin, Buchhaltung, Vorstand, Support, Mitglied). Least-Privilege.
* **AuthN/Z**: OIDC/OAuth2, MFA f√ºr Admins, Sitzungsh√§rtung, CSRF-Schutz.
* **DSGVO**: Explizite Einwilligungen (DSGVO, Statuten, Beitragsordnung) versioniert mit Timestamp/IP; Aufbewahrungsfristen; Datenminimierung.
* **Audit-Trail** l√ºckenlos (CRUD, Exporte, L√∂schungen).
* **Secrets**: nur in Vault/Secrets Manager; niemals im Repo.
* **Backups**: PITR f√ºr DB, Versionierung f√ºr S3, Disaster-Recovery-Runbook.

---

## 9) Tests & Qualit√§tssicherung

* **Unit**: Validierung (Zod/Yup), Mapper, Buchungslogik, Webhook-Parser.
* **Integration**: Endpunkte, DB-Transaktionen, Zahlungsfl√ºsse (Sandbox).
* **E2E (Playwright)**: Beitritt, Spende (alle Zahlungsarten), Abo-Charge, Mahnwesen.
* **Visuelle Regression**: xs/md/lg-Screenshots der kritischen Seiten.
* **A11y (axe-core)**: keine ‚Äûserious/critical‚Äú.
* **Lighthouse (mobil)**: Budgets enforced.
* **Security**: SAST/Dependency-Audit, Rate-Limit, Fuzzing der Webhooks.
* **CI/CD-Gates**: Build fail bei A11y-Fehler, Visual-Diff >1 %, Test-Fail, LCP/INP/CLS au√üerhalb Budget, Audit-High.

---

## 10) Dokumentation (immer, automatisch)

* **README** (Setup, Run, Test, Deploy),
* **ARCHITECTURE.md** (Diagramme, Datenfl√ºsse),
* **API-Spex** (OpenAPI/GraphQL Schema),
* **DATA-MODEL.md** (ER-Diagramm, DSGVO-Felder),
* **RUNBOOKS** (Incidents, DR, On-Call),
* **SOPs** (Bank-CSV, Mahnwesen, Periodenabschluss),
* **SECURITY.md** (RBAC, Secrets, Compliance),
* **CHANGELOG/ADRs** (Entscheidungen),
* **AUTOMATION.md** (n8n-Workflows mit Screens & JSON-Exports).

> n8n-Workflows werden bei jeder √Ñnderung exportiert (JSON) und versioniert; Commits automatisch mit Diff-Kommentar.

---

## 11) Konkrete Deliverables (jede Ausf√ºhrung liefern)

1. **Architektur-Diagramm** (PNG + PlantUML/Mermaid)
2. **OpenAPI** (YAML/JSON) + Beispiel-Requests
3. **DB-Migrations** (Postgres) + Seed-Daten
4. **Frontend**: Seiten/Komponenten (Mitglied werden, Spenden, Portal, Admin, Dashboard) ‚Äì HTML/JSX mit i18n/A11y/Selektoren
5. **Backend**: Controller/Services/Mapper/Policies + Tests
6. **Buchhaltung**: Kontenplan, Journal-Posting-Regeln, Exporte
7. **n8n**: Workflow-JSONs (7 Kernflows), Env-Template, Alerts
8. **PDF-Vorlagen**: Rechnung/Beleg/Mahnung (MJML/HTML ‚Üí PDF)
9. **Scripts**: Bank-CSV Import, Reconciliation, Report-Generator
10. **CI/CD**: Pipelines (Lint, Test, Build, E2E, A11y, Visual, Deploy)
11. **Doku-Bundle** (alle Kapitel oben) + **Checkliste** (‚úÖ/‚ö†Ô∏è)

---

## 12) Abnahme-Checkliste (hart)

* ‚úÖ **Recht & DSGVO:** Zustimmungen versioniert, Self-Service aktiv, L√∂schung/Export gepr√ºft
* ‚úÖ **Zahlungen:** alle vereinbarten Methoden lauff√§hig (Sandbox), PSP-Webhooks synchronisieren Status
* ‚úÖ **Buchhaltung:** double-entry korrekt, Geb√ºhren getrennt, Bankabgleich funktioniert, Exporte plausibel
* ‚úÖ **Performance:** LCP ‚â§2.5s, INP ‚â§200ms, CLS ‚â§0.1 mobil
* ‚úÖ **A11y:** axe-core ohne ‚Äûserious/critical‚Äú
* ‚úÖ **Sicherheit:** RBAC, MFA f√ºr Admins, Audit-Trail, Secrets sicher
* ‚úÖ **Automationen:** n8n Flows idempotent, Retry/DLQ/Alerting aktiv
* ‚úÖ **Tests:** Unit/Integration/E2E/Visual gr√ºn; CI-Gates enforced
* ‚úÖ **Doku:** vollst√§ndig, aktuell, versioniert (inkl. n8n-JSON)

---

## 13) Prompt-Satz (zum direkten Einsatz)

> ‚ÄûErzeuge die **vollst√§ndige Vereinsplattform** gem√§√ü obiger Spezifikation f√ºr *Menschlichkeit √ñsterreich*:
> ‚Äì Frontend (√∂ffentliche Seiten, Mitgliederportal, Admin-Konsole, Dashboard)
> ‚Äì Backend (REST/OpenAPI, RBAC, Audit-Trail)
> ‚Äì Datenbank (Postgres Schema & Migrations)
> ‚Äì Buchhaltung (Kontenplan, Journal-Regeln, Exporte, Bankabgleich, Mahnwesen)
> ‚Äì Zahlungen (Bank/SEPA/Debit/Kredit/EPS/Sofort/PayPal/Apple/Google/Pos/Bar, PSP-Webhooks)
> ‚Äì n8n Workflows (7 Kernprozesse, Idempotenz/Retry/DLQ/Alerting)
> ‚Äì Dokumentenvorlagen (Rechnung/Beleg/Mahnung)
> ‚Äì CI/CD Pipelines mit harten Quality Gates
> ‚Äì Vollst√§ndige Dokumentation inkl. RUNBOOKS, SOPs, SECURITY, DATA-MODEL, AUTOMATION.
> Liefere alle **Artefakte** (Code-Skeletons, YAML/JSON, Diagramme, Tests, n8n-Exports) so, dass `npm i && docker compose up` eine lauff√§hige Dev-Umgebung startet. H√§nge die **Abnahme-Checkliste** an und best√§tige die Kriterien automatisiert.‚Äú