#############################################################################
# Logstash Pipeline: FastAPI Logs
# Purpose: Process FastAPI JSON logs (already PII-sanitized via Phase 1)
#############################################################################

input {
  pipeline {
    address => "fastapi"
  }
}

#############################################################################
# FILTER: Parse JSON + Extract Fields
#############################################################################
filter {
  # Parse JSON payload
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "log_data"
    }
  }
  
  # Extract Standard Fields
  if [log_data] {
    mutate {
      add_field => {
        "service" => "fastapi"
        "level" => "%{[log_data][level]}"
        "logger" => "%{[log_data][logger]}"
        "user_id" => "%{[log_data][user_id]}"
        "action" => "%{[log_data][action]}"
        "method" => "%{[log_data][method]}"
        "path" => "%{[log_data][path]}"
        "status_code" => "%{[log_data][status_code]}"
        "duration_ms" => "%{[log_data][duration_ms]}"
        "ip_masked" => "%{[log_data][ip_masked]}"
      }
    }
    
    # Replace message with clean log message
    mutate {
      replace => { "message" => "%{[log_data][message]}" }
    }
  }
  
  # Validate PII Sanitization (double-check for email bypass)
  # NOTE: FastAPI logs SHOULD be PII-free, but we verify
  if [message] =~ /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/ {
    mutate {
      add_tag => ["pii_bypass_detected"]
      add_field => {
        "pii_bypass_type" => "email"
        "pii_bypass_severity" => "CRITICAL"
      }
    }
  }
  
  # Add Environment Tag
  if [service] == "fastapi" {
    if "stg" in [host][name] or "staging" in [host][name] {
      mutate { add_field => { "environment" => "staging" } }
    }
    else {
      mutate { add_field => { "environment" => "production" } }
    }
  }
  
  # Clean Up Temporary Fields
  mutate {
    remove_field => ["log_data"]
  }
}

#############################################################################
# OUTPUT: Elasticsearch
#############################################################################
output {
  # Send to Operational Logs Index
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTICSEARCH_PASSWORD}"
    index => "logs-operational-%{+YYYY.MM.dd}"
    data_stream => false
  }
  
  # If PII Bypass Detected â†’ Send to Security Audit Index
  if "pii_bypass_detected" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTICSEARCH_PASSWORD}"
      index => "logs-security-audit-%{+YYYY.MM.dd}"
      data_stream => false
    }
  }
}
