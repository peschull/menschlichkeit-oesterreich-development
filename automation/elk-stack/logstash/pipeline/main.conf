#############################################################################
# Logstash Pipeline: Main (Universal Input Router)
# Purpose: Routes incoming logs to appropriate pipelines
#############################################################################

input {
  # Beats Input (Filebeat from FastAPI, n8n, Keycloak, etc.)
  beats {
    port => 5044
    type => "beats"
    tags => ["beats"]
  }

  # Syslog Input (Drupal/CiviCRM)
  syslog {
    port => 5140
    type => "syslog"
    tags => ["syslog", "drupal"]
  }

  # HTTP Input (Frontend Browser Logs)
  http {
    port => 8080
    type => "http"
    tags => ["http", "frontend"]
    codec => json
  }
}

#############################################################################
# FILTER: Universal Pre-Processing
#############################################################################
filter {
  # Add Timestamp
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Service Detection (from tags or fields)
  if "fastapi" in [tags] or [service] == "fastapi" {
    mutate { add_tag => ["route_to_fastapi"] }
  }
  else if "drupal" in [tags] or [service] == "drupal" or [service] == "civicrm" {
    mutate { add_tag => ["route_to_drupal"] }
  }
  else if "n8n" in [tags] or [service] == "n8n" {
    mutate { add_tag => ["route_to_n8n"] }
  }
  else if "frontend" in [tags] or [service] == "frontend" {
    mutate { add_tag => ["route_to_frontend"] }
  }
  else {
    mutate { add_tag => ["route_to_generic"] }
  }
}

#############################################################################
# OUTPUT: Route to Specific Pipelines or Elasticsearch
#############################################################################
output {
  # FastAPI Logs
  if "route_to_fastapi" in [tags] {
    pipeline { send_to => ["fastapi"] }
  }

  # Drupal/CiviCRM Logs
  else if "route_to_drupal" in [tags] {
    pipeline { send_to => ["drupal"] }
  }

  # n8n Logs
  else if "route_to_n8n" in [tags] {
    pipeline { send_to => ["n8n"] }
  }

  # Frontend Logs (CRITICAL: Needs PII sanitization!)
  else if "route_to_frontend" in [tags] {
    pipeline { send_to => ["frontend"] }
  }

  # Generic/Unknown Logs (direct to Elasticsearch with basic sanitization)
  else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTICSEARCH_PASSWORD}"
      index => "logs-generic-%{+YYYY.MM.dd}"
      data_stream => false
    }
  }

  # Debug Output (disabled in production)
  # stdout { codec => rubydebug }
}
